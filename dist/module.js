const s="segue",l="Segue";class O{static async executeFullSegue(e,a){var D,E;console.log(`%cðŸŽ¬ ${l} | Initiating Segue to ${e.name}`,"color: orange; font-weight: bold;");const{displayText:t,fadeOutDuration:n,textDisplayDuration:r,fadeInDuration:u,textSize:o,textColor:f,fontFamily:w,textFadeInDuration:F,textFadeOutDuration:I}=a,c=$('<div class="segue-overlay"></div>'),S=$(`<div class="segue-text">${t}</div>`),M=game.settings.get(s,"segueOverUI"),U=game.settings.get(s,"gmSegueUnderUI");let m;M?m=99999:m=29,(D=game.user)!=null&&D.isGM&&(U?m=29:m=99999),c.css({position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"black",opacity:0,zIndex:m}),await document.fonts.load(`${o}px "${w}"`),S.css({position:"absolute",top:"50%",left:"50%",width:"80%",whiteSpace:"pre-line",transform:"translate(-50%, -50%)",color:f,fontSize:`${o}px`,textAlign:"center",textShadow:"2px 2px 4px rgba(0,0,0,0.7)",opacity:0,fontFamily:w}),c.append(S),$("body").append(c);const C=g=>new Promise(b=>setTimeout(b,g));try{await c.animate({opacity:1},n,"linear").promise(),(E=game.user)!=null&&E.isGM?await e.activate():console.log(`${l} | Player awaiting GM scene activation for: ${e.name}...`);const g=new Promise(v=>{const x=Hooks.once("canvasReady",d=>{var G,k;((G=d.scene)==null?void 0:G.id)===e.id?(console.log(`%cðŸŽ¬ ${l} | ${d.scene.name} canvas ready in background`,"color: orange; font-weight: bold;"),Hooks.off("canvasReady",x),v()):(console.warn(`${l} | canvasReady fired for incorrect scene (${((k=d.scene)==null?void 0:k.name)||"N/A"})`),Hooks.off("canvasReady",x),v())});setTimeout(()=>{var d;((d=canvas.scene)==null?void 0:d.id)!==e.id&&console.warn(`${l} | canvasReady timeout for scene ${e.name}`),Hooks.off("canvasReady",x),v()},Math.max(5e3,n+r+u+2e3))}),b=(async()=>{t?(await S.animate({opacity:1},F,"linear").promise(),await C(Math.max(0,r-1e3)),await S.animate({opacity:0},I,"linear").promise()):await C(500)})();await Promise.all([g,b]),await c.animate({opacity:0},u,"linear").promise()}catch(g){console.error(`${l} | Error during segue:`,g),ui.notifications.error(game.i18n.localize("SEGUE.Notifications.SegueFailed")+": "+g.message)}finally{c.remove(),console.log(`%cðŸŽ¬ ${l} | Segue to ${e.name} complete!`,"color: orange; font-weight: bold;")}}}const h={enabled:!1,displayText:"",fadeOutDuration:2e3,textDisplayDuration:4e3,fadeInDuration:2e3,textSize:48,textColor:"#CFC3AA",fontFamily:"Goudy Bookletter",textFadeInDuration:1e3,textFadeOutDuration:1e3};class p{static registerSettings(){game.settings.register(s,"segueOverUI",{name:"SEGUE.GlobalSettings.SegueOverUI.Name",hint:"SEGUE.GlobalSettings.SegueOverUI.Hint",scope:"world",config:!0,type:Boolean,default:!0}),game.settings.register(s,"gmSegueUnderUI",{name:game.i18n.localize("SEGUE.GlobalSettings.gmSegueUnderUI.Name"),hint:game.i18n.localize("SEGUE.GlobalSettings.gmSegueUnderUI.Hint"),scope:"world",config:!0,type:Boolean,default:!0})}static getSceneConfiguration(e){const t=e.flags[s];if(!t)return{...h};const n={...h};for(const[r,u]of Object.entries(h)){const o=t[r];o!=null&&!(typeof o=="string"&&o.trim()==="")&&(n[r]=o)}return n}}const z=[{value:"Almendra",label:"Almendra"},{value:"Balthazar",label:"Balthazar"},{value:"Bellefair",label:"Bellefair"},{value:"Chau Philomene One",label:"Chau Philomene One"},{value:"Codystar",label:"Codystar"},{value:"Creepster",label:"Creepster"},{value:"Ewert",label:"Ewert"},{value:"Frijole",label:"Frijole"},{value:"Germania One",label:"Germania One"},{value:"Goudy Bookletter 1911",label:"Goudy Bookletter 1911"},{value:"Great Vibes",label:"Great Vibes"},{value:"Grenze Gotisch",label:"Grenze Gotisch"},{value:"Griffy",label:"Griffy"},{value:"IM Fell English",label:"IM Fell English"},{value:"Love Ya Like A Sister",label:"Love Ya Like A Sister"},{value:"Macondo",label:"Macondo"},{value:"Metal Mania",label:"Metal Mania"},{value:"Modern Antiqua",label:"Modern Antiqua"},{value:"Nosifer",label:"Nosifer"},{value:"Permanent Marker",label:"Permanent Marker"},{value:"Pirata One",label:"Pirata One"},{value:"Quintessential",label:"Quintessential"},{value:"Rock Salt",label:"Rock Salt"},{value:"Rubik Distressed",label:"Rubik Distressed"},{value:"Sancreek",label:"Sancreek"},{value:"Sixtyfour Convergence",label:"Sixtyfour Convergence"},{value:"Sixtyfour",label:"Sixtyfour"},{value:"Special Elite",label:"Special Elite"},{value:"Syne Mono",label:"Syne Mono"},{value:"Trade Winds",label:"Trade Winds"},{value:"UnifrakturMaguntia",label:"UnifrakturMaguntia"},{value:"VT323",label:"VT323"}];async function N(i,...e){const a=await i(...e),t=p.getSceneConfiguration(this.document);a.segue=t;let n=[];CONFIG.fontDefinitions&&(n=Object.entries(CONFIG.fontDefinitions).map(([o,f])=>({value:o,label:f.family||o})));const r=[...n,...z],u=new Set;return a.fontFamilies=r.filter(o=>u.has(o.value)?!1:(u.add(o.value),!0)),a.fontFamilies.sort((o,f)=>o.label.localeCompare(f.label)),a}function T(){const i=foundry.applications.sheets.SceneConfig,e=i.PARTS,a=e.footer;delete e.footer,e.segue={template:`modules/${s}/templates/scene-config.hbs`},e.footer=a,i.TABS.sheet.tabs.push({id:"segue",label:"Segue",icon:"fa-regular fa-route"}),libWrapper.register(s,"foundry.applications.sheets.SceneConfig.prototype._prepareContext",N)}function A(i){var n;const e=$(i),a=e.data("sceneId")||e.data("entryId")||e.data("documentId");if(!a)return;const t=(n=game.scenes)==null?void 0:n.get(a);if(t)return t}let y;Hooks.once("init",()=>{y=window.socketlib.registerModule(s),y.register("startSegue",async i=>{var t,n,r;const e=(t=game.scenes)==null?void 0:t.get(i);if(!e){console.warn(`${l} | Socketlib: Could not find scene with ID ${i}`);return}if(((n=canvas.scene)==null?void 0:n.id)===e.id){(r=game.user)!=null&&r.isGM&&ui.notifications.info(`${l} | Target scene "${e.name}" is already active. Segue NOT proceeding.`);return}const a=p.getSceneConfiguration(e);await O.executeFullSegue(e,{displayText:a.displayText,fadeOutDuration:a.fadeOutDuration,textDisplayDuration:a.textDisplayDuration,fadeInDuration:a.fadeInDuration,textSize:a.textSize,textColor:a.textColor,fontFamily:a.fontFamily,textFadeInDuration:a.textFadeInDuration,textFadeOutDuration:a.textFadeOutDuration})}),p.registerSettings(),foundry.applications.handlebars.loadTemplates([`modules/${s}/templates/scene-config.hbs`])});Hooks.once("ready",()=>{var e;const i=((e=game.modules.get(s))==null?void 0:e.version)??"unknown";console.log(`%cðŸŽ¬ ${l} | ${i} Ready`,"color: orange; font-weight: bold;"),T()});Hooks.on("getSceneContextOptions",(i,e)=>(e.push({name:"Segue",icon:'<i class="fas fa-film"></i>',condition:a=>{var t;return(t=game.user)==null?void 0:t.isGM},callback:async a=>{const t=A(a);if(!t){ui.notifications.error(game.i18n.localize("SEGUE.Notifications.SceneNotFound"));return}if(!p.getSceneConfiguration(t).enabled){ui.notifications.info(game.i18n.localize("SEGUE.Notifications.SegueNotEnabled"));return}y?await y.executeForEveryone("startSegue",t.id):(console.error(`${l} | segueSocket failed to intialize`),ui.notifications.error(`${l} | segueSocket failed to initialize.`))}}),e));
